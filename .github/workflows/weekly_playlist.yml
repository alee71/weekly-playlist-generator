  name: Generate Weekly Playlist

  on:
    workflow_dispatch:
    schedule:
      - cron: '0 12 * * 5'

  jobs:
    generate-playlist:
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
        - uses: actions/checkout@v4
          with:
            ref: master

        - uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y ffmpeg
            pip install -r requirements.txt

        - name: Run generator
          run: python -m src.main

        - name: Commit changes
          run: |
            git config user.email "actions@github.com"
            git config user.name "github-actions"
            git pull --rebase origin master
            git add data/
            git diff --staged --quiet || git commit -m "Update playlist"
            git push

        - uses: actions/upload-artifact@v4
          with:
            name: weekly-playlist
            path: data/output/playlist_*.txt
            retention-days: 30
